module org/webdsl/dsl/to-java-servlet/test/test-web

imports
  libstrategolib
  libjava-front

imports
  libwebdsl-front
  org/webdsl/dsl/to-java-servlet/to-java-servlet

strategies

  GenerateCodeJavaServlet = if-test(generate-test-web); fail

  generate-test-web :
     Application(_,_) ->
     <emit-java-code> compilation-unit|[
       //package pkgname;
       package utils;
       import pkgname.*;
       import pkgname2.*;
       import pkgname3.*;
       import utils.*;
       import org.webdsl.lang.*;
       import org.webdsl.tools.*;
       import org.hibernate.*;
       
       import java.net.ServerSocket;
       
       import org.openqa.selenium.By;
       import org.openqa.selenium.WebDriver;
       import org.openqa.selenium.WebElement;
       import org.openqa.selenium.htmlunit.HtmlUnitDriver;
       
       import org.codehaus.cargo.container.*;
       import org.codehaus.cargo.container.deployable.*;
       import org.codehaus.cargo.container.tomcat.*;
       import org.codehaus.cargo.container.property.*; 
       
       public class TestWeb extends TestAll
       {
          public TestWeb () {

          }

          public static final String contextPath = "~<AppName>";
          public static final boolean isPost = false;
          public static int SERVLET_PORT = 0;
          public static int RMI_PORT = 0;
          
          public static void runTests(){
            boolean exitWithError = false;
            
            bstm*
            
            if(exitWithError){
              System.exit(1);
            }
          }

          public static void main(String[] args) {
            
            DispatchServletHelper d = new DispatchServletHelper(null, isPost, contextPath);
            ThreadLocalServlet.set(d);
          
            String warfile = "./"+"~<AppName>"+".war";
            System.out.println(warfile);
            Deployable war = new WAR(warfile);

            org.codehaus.cargo.container.configuration.LocalConfiguration configuration = new Tomcat6xStandaloneLocalConfiguration("tomcat6x");
            
            // find two free ports
            try {
            	ServerSocket ss1 = new ServerSocket(0);
            	ServerSocket ss2 = new ServerSocket(0);
            	SERVLET_PORT = ss1.getLocalPort();
            	RMI_PORT = ss2.getLocalPort();
            	ss1.close(); ss2.close();
            } catch (java.io.IOException ioex) {
            	System.out.println("Cannot find free port for test context.");
            	ioex.printStackTrace();
            	System.exit(1);
            }
            
            configuration.setProperty(ServletPropertySet.PORT, new Integer(SERVLET_PORT).toString());
            configuration.setProperty(GeneralPropertySet.RMI_PORT, new Integer(RMI_PORT).toString());
            
            configuration.addDeployable(war);
      
            InstalledLocalContainer container = new Tomcat6xInstalledLocalContainer(configuration);
            String tomcathome = "./tomcat/apache-tomcat-6.0.20/";
            System.out.println(tomcathome);
            container.setHome(tomcathome);
            container.setLogger(new org.codehaus.cargo.util.log.SimpleLogger(){     
              protected void doLog(org.codehaus.cargo.util.log.LogLevel level, String message, String category)
     	      {
                //System.out.println("[" + level.getLevel() + "][" + category + "] " + message);
                System.out.println(message);
              } 
            });
            
            container.start(); 
             
            runTests();

            container.stop();            
          }
       }
     ]|
     with pkgname := <TestPackage>
        ; pkgname2 := <BeanPackage>
        ; pkgname3 := <DomainPackage>
        ; names := <bagof-AllTestNames <+ ![]>
        ; bstm* := <map(gen-call-test-web-class);concat> names  
       
  gen-call-test-web-class :
    name -> 
      bstm*|[ 
        x_name x_var = new x_name(); 
        x_var.closeTransactionBecauseOfSqliteConcurrencyLimitation = true;
        //x_var.setWebClient(new HtmlUnitDriver()); //use HTMLUnit for now, but webdriver also supports using external browsers such as firefox
        exitWithError = !x_var.run() || exitWithError; 
      ]|
    with x_name := <concat-strings> ["Test", name]
       ; x_var := <concat-strings> ["varTest", name]
    