#!@bash@

SRCDIR=$(pwd)/../src
cd `dirname $0`
FILE=`basename $0 .sh`
bash @prefix@/bin/webdsl cleanall > /dev/null 2> /dev/null
bash @prefix@/bin/webdsl test $FILE 2>&1 | cat > $FILE.out

exec 3<> $FILE.app
while read line <&3
do
  if echo "$line" | grep -q "^//"; then
    pattern=`echo "$line" | sed 's/^[/]*//'`
    echo $pattern | grep -q "^\^"
    negate=$?
    
    if (( ! $negate )); then
      if grep -q "${pattern:1}" $FILE.out; then
        echo "Error should not be present: ${pattern:1}"
        is_error=1
      fi
    else
      if ! grep -q "$pattern" $FILE.out; then
        echo "Error should be present: $pattern"
        is_error=1
      fi
    fi
    
  else
    break
  fi
done
exec 3>&-

if [[ $is_error ]]; then
  echo "------------------------------------"
  echo
  cat $FILE.out
  exit 1
fi

exit 0
