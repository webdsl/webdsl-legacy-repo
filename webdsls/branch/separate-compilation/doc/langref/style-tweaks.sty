%                        Font
%                        ----

% Palatino
\usepackage[osf,sc]{mathpazo} 

% txtt for tt
\renewcommand{\ttdefault}{txtt}

% Computer Modern for tt
% \renewcommand{\ttdefault}{cmtt}

% Helvetica for sans serif.
% \renewcommand{\sfdefault}{qhv}
\usepackage[scaled=0.95]{helvet}

\SetMathAlphabet\mathsf{normal}\encodingdefault\sfdefault\mddefault\updefault
\SetMathAlphabet\mathsf{bold}\encodingdefault\sfdefault\bfdefault\updefault

% TeX Gyre Termes
% \renewcommand{\rmdefault}{qtm} 

% Times
% \usepackage{times}

%% \renewcommand{\familydefault}{\rmdefault}
%% \fontfamily{\familydefault}
% \renewcommand{\rmdefault}{ptm}

\newcommand{\allttsize}[0]{\fontsize{9pt}{9pt}}
\newcommand{\codeblocksize}[0]{\allttsize}

%% \let\oldalltt=\alltt
%% \def\alltt{\allttsize\begin{oldalltt}}%
%% \def\endalltt{\end{oldalltt}}%
%%\renewenvironment{alltt}{\allttsize\begin{oldalltt}}{\end{oldalltt}}

\newenvironment{codeblock}{\allttsize\begin{alltt}}{\end{alltt}}
\let\oldtexttt\texttt
\renewcommand{\texttt}[1]{\allttsize\oldtexttt{#1}}

%                        Page layout
%                        -----------

\parindent 1pc

\usepackage{fancyhdr}
\pagestyle{fancy}

\fancyhead{}
\fancyfoot{}
\fancyfoot[LE,RO]{\thepage}
\fancyfoot[LO]{\leftmark}
\renewcommand{\chaptermark}[1]{\markboth{Chapter \thechapter{}. \itshape #1}{}}

    % \fancyfoot[RE]{\rightmark}
    % \renewcommand{\sectionmark}[1]{\markright{\itshape #1}}

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}

%% \def\footrule{{\vskip-0.3\normalbaselineskip\vskip-\footrulewidth%
%% \hrule width 0.33\headwidth\@height\footrulewidth\vskip0.3\normalbaselineskip}}

\fancypagestyle{plain}{%
\fancyhf{} % clear all header and footer fields
\fancyfoot[LE,RO]{\thepage}%
}

% Disable single lines at the start of a paragraph (Schusterjungen)
\clubpenalty = 9999
% Disable single lines at the end of a paragraph (Hurenkinder)
\widowpenalty = 9999
%% \displaywidowpenalty = 9999 % formulas

%                        Floats
%                        ------

\renewcommand{\topfraction}{0.9}	% max fraction of floats at top
\renewcommand{\bottomfraction}{0.8}	% max fraction of floats at bottom
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{4}     % 2 may work better
\setcounter{dbltopnumber}{2}    % for 2-column pages
\renewcommand{\dbltopfraction}{0.9}	% fit big float above 2-col. text
\renewcommand{\textfraction}{0.07}	% allow minimal text w. figs
\renewcommand{\floatpagefraction}{0.7}	% require fuller float pages
\renewcommand{\dblfloatpagefraction}{0.7}	% require fuller float pages

%                       Utilities
%                       ---------

\newcommand{\setvspace}[2]{%
  #1 = #2
  \advance #1 by -1\parskip}

%                       Flags (Booleans)
%                       ----- ----------

% The boolean literals \@true and \@false are appropriate for use with
% the \if command, which tests the codes of the next two characters.

\def \@true {TT}
\def \@false {FL}

\def \@setflag #1=#2{\edef #1{#2}}%              \flag = boolean


%                       Options
%                       -------

\@setflag \@blockstyle = \@false
\@setflag \@mathtime = \@false
\newcount{\@numheaddepth} \@numheaddepth = 3
\@setflag \@times = \@false

%                       Hierarchy
%                       ---------

\newenvironment{abstract}{\section*{Abstract}}{}

\definecolor{halfgray}{gray}{0.6} 
\newfont{\chapterNumber}{ptmb scaled 7000} % cmbx10
\sodef\allcapsspacing{\upshape}{0.15em}{0.65em}{0.6em}  % OLD: {0.1em}{0.5em}{0.6em}
\DeclareRobustCommand{\spacedallcaps}[1]{\MakeTextUppercase{\allcapsspacing{#1}}}

\sodef\paraspacing{\upshape}{0.1em}{0.5em}{0.6em}
\DeclareRobustCommand{\paracaps}[1]{\MakeTextUppercase{\paraspacing{#1}}}

\newcommand{\numbersouth}{1.2}
\newcommand{\singlelinetitle}{\renewcommand{\numbersouth}{1.2}}
\newcommand{\doublelinetitle}{\renewcommand{\numbersouth}{1.7}}

\titleformat{\chapter}[display]
  {\relax}{{\color{halfgray}\begin{textblock}{2}(11.8,\numbersouth)%
            \chapterNumber\thechapter\end{textblock}}}{0pt}%
  {\LARGE\raggedright}[\normalsize\vspace*{.8em}\titlerule] % \large 1.25

%% \titlespacing{\chapter}{0pt}{*0}{*3.3}

\titleformat{\section}
  {\relax}{\makebox[2.5em]{\thesection\hfill}}{0.3em}{\spacedallcaps}

\titleformat{\subsection}
  {\relax}{\makebox[2.5em]{\thesubsection\hfill}}{0.3em}{\normalsize\itshape}

\titleformat{\subsubsection}
  {\relax}{\makebox[2.5em]{\thesubsubsection}}{1em}{\normalsize\itshape}

\titleformat{\paragraph}[runin]
  {\normalfont\normalsize}{\theparagraph}{0pt}{\small\textsc}

\titlespacing*{\chapter}{0pt}{0em}{1.4em}
\titlespacing*{\section}{0pt}{1.4em}{1.2em}
\titlespacing*{\subsection}{0pt}{1.2em}{1em}
\titlespacing*{\subsubsection}{0pt}{0.7em}{0.5em}
\titlespacing*{\paragraph}{0pt}{0.5em}{0.7em}

%                       Enumerations
%                       ------------

\renewcommand{\descriptionlabel}[1]{\textit{#1}}

%
%                       ----- ----------


\newcommand{\nut}{\hspace{.5em}}

\def \@dimgtrp   #1#2{\ifdim #1 > #2\@true \else \@false \fi}


%                       Figures
%                       -------

\@setflag \@caprule = \@true

\long\def \@makecaption #1#2{%
  \addvspace{4pt}
  \if \@caprule
    \hrule width \hsize height .33pt
    \vspace{5pt}
  \fi
  \setbox \@tempboxa = \hbox{\@setfigurenumber{#1}\nut \sf \selectfont #2}%
  \if \@dimgtrp{\wd\@tempboxa}{\hsize}%
    \noindent \@setfigurenumber{#1}\nut \sf #2\par
  \else
    \centerline{\box\@tempboxa}%
  \fi}

\newcommand{\nocaptionrule}{%
  \@setflag \@caprule = \@false}

\def \@setfigurenumber #1{%
  {\normalfont \sf \selectfont #1}}

%                       Table of Contents
%                       -----------------

\renewcommand\tableofcontents{%
    \if@twocolumn
      \@restonecoltrue\onecolumn
    \else
      \@restonecolfalse
    \fi
    \chapter*{\contentsname
        \@mkboth{\itshape \contentsname}{\itshape \contentsname}}%
    \pdfbookmark[0]{Contents}{dunno-contents}%
    \@starttoc{toc}%
    \if@restonecol\twocolumn\fi
    }

%                       Bibliography
%                       ------------

\renewenvironment{thebibliography}[1]
     {\chapter*{\bibname}%
%%      \let\cite=\bibshortcite
      \@mkboth{\itshape \bibname}{\itshape \bibname}%
      \addcontentsline{toc}{chapter}{\bibname}%
      \list{\@biblabel{\@arabic\c@enumiv}}%
           {\settowidth\labelwidth{\@biblabel{#1}}%
            \leftmargin\labelwidth
            \advance\leftmargin\labelsep
            \@openbib@code
            \usecounter{enumiv}%
            \let\p@enumiv\@empty
            \renewcommand\theenumiv{\@arabic\c@enumiv}}%
      \sloppy
      \clubpenalty4000
      \@clubpenalty \clubpenalty
      \widowpenalty4000%
      \sfcode`\.\@m}
     {\def\@noitemerr
       {\@latex@warning{Empty `thebibliography' environment}}%
      \endlist}

\usepackage{breakcites}

\let\@internalcite\cite
\def\shortcite{\def\citeauthoryearch##1##2##3##4{##2\ifnotempty{##4}{##4}\ifnotempty{##3}{ (Chapter ##3)}}\@internalcite}
\def\bibshortcite{\def\citeauthoryearch##1##2##3##4{##2\ifnotempty{##4}{##4}}\@internalcite}
\let\cite=\shortcite


\def\ifnotempty#1#2{%
  \def\temptyA{#1}%
  \ifx\temptyA\empty\else\ #2\fi%
}



\def\rightminipage{\@ifnextchar [{\@irightminipage}{\@irightminipage[c]}}

\def\@irightminipage[#1]#2{\leavevmode \@pboxswfalse
  \if #1b\vbox
    \else \if #1t\vtop
             \else \ifmmode \vcenter
                       \else \@pboxswtrue $\vcenter
                    \fi
          \fi
  \fi\bgroup % start of outermost vbox/vtop/vcenter
    \hsize #2
    \hbox\bgroup % inner hbox
      \vrule\@width\fboxrule \hskip\fboxsep \vbox\bgroup % innermost vbox
        \vskip\fboxsep
        \advance\hsize -2\fboxrule \advance\hsize-2\fboxsep
        \textwidth\hsize \columnwidth\hsize
        \@parboxrestore
        \def\@mpfn{mpfootnote}\def\thempfn{\thempfootnote}\c@mpfootnote\z@
        \let\@footnotetext\@mpfootnotetext
        \let\@listdepth\@mplistdepth \@mplistdepth\z@
        \@minipagerestore\@minipagetrue
        \everypar{\global\@minipagefalse\everypar{}}}

\def\endrightminipage{%
        \par\vskip-\lastskip
        \ifvoid\@mpfootins\else
          \vskip\skip\@mpfootins\footnoterule\unvbox\@mpfootins\fi
        \vskip\fboxsep
      \egroup % ends the innermost \vbox
      \hskip\fboxsep
    \egroup % ends the \hbox
  \egroup% ends the vbox/vtop/vcenter
  \if@pboxsw $\fi}

\def\leftrightminipage{\@ifnextchar [{\@ileftrightminipage}{\@ileftrightminipage[c]}}

\def\@ileftrightminipage[#1]#2{\leavevmode \@pboxswfalse
  \if #1b\vbox
    \else \if #1t\vtop
             \else \ifmmode \vcenter
                       \else \@pboxswtrue $\vcenter
                    \fi
          \fi
  \fi\bgroup % start of outermost vbox/vtop/vcenter
    \hsize #2
    \hbox\bgroup % inner hbox
      \vrule\@width\fboxrule \hskip\fboxsep \vbox\bgroup % innermost vbox
        \vskip\fboxsep
        \advance\hsize -2\fboxrule \advance\hsize-2\fboxsep
        \textwidth\hsize \columnwidth\hsize
        \@parboxrestore
        \def\@mpfn{mpfootnote}\def\thempfn{\thempfootnote}\c@mpfootnote\z@
        \let\@footnotetext\@mpfootnotetext
        \let\@listdepth\@mplistdepth \@mplistdepth\z@
        \@minipagerestore\@minipagetrue
        \everypar{\global\@minipagefalse\everypar{}}}

\def\endleftrightminipage{%
        \par\vskip-\lastskip
        \ifvoid\@mpfootins\else
          \vskip\skip\@mpfootins\footnoterule\unvbox\@mpfootins\fi
        \vskip\fboxsep
      \egroup % ends the innermost \vbox
      \hskip\fboxsep \vrule\@width\fboxrule
    \egroup % ends the \hbox
  \egroup% ends the vbox/vtop/vcenter
  \if@pboxsw $\fi}

